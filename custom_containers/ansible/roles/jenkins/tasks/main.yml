- name: Ensure docker network exists (local to this host)
  community.docker.docker_network:
    name: "{{ docker_network }}"
    state: present

- name: Build custom Jenkins image on target host
  community.docker.docker_image:
    name: "{{ jenkins_image_name }}"
    tag: "{{ image_tag }}"
    build:
      path: "{{ project_root }}/jenkins_custom"
      dockerfile: Dockerfile
    source: build

- name: Run Jenkins container (custom image)
  community.docker.docker_container:
    name: jenkins
    image: "{{ jenkins_image_name }}:{{ image_tag }}"
    user: root
    published_ports: "{{ jenkins_ports }}"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    env:
      JAVA_OPTS: "-Djava.awt.headless=true"
    networks:
      - name: "{{ docker_network }}"
    restart_policy: unless-stopped
